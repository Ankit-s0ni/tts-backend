# Email Authentication & Cloudinary Setup - Quick Reference

## üìã Overview

This TTS backend now uses:
- **Email/Password Authentication** with JWT tokens (replaces AWS Cognito)
- **Resend** for sending verification emails
- **Cloudinary** for file storage (replaces AWS S3)

## üöÄ Quick Start

```bash
# 1. Run the setup script
./setup_email_auth.sh

# 2. Update .env with your credentials (if not already set)
# Edit .env and add your Resend and Cloudinary keys

# 3. Start the server
uvicorn app.main:app --reload --port 8000
```

## üîë Required Environment Variables

```env
# JWT Secret (auto-generated by setup script)
JWT_SECRET_KEY=your-generated-secret-key

# Resend Email Service
RESEND_API_KEY=re_your_resend_api_key

# Cloudinary File Storage
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

## üìö API Endpoints

### Authentication

#### Register New User
```bash
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123",
  "full_name": "John Doe"
}

Response: 201 Created
{
  "message": "Registration successful...",
  "email": "user@example.com",
  "user_id": 1
}
```

#### Verify Email
```bash
POST /auth/verify-email
Content-Type: application/json

{
  "email": "user@example.com",
  "code": "123456"
}

Response: 200 OK
{
  "message": "Email verified successfully",
  "access_token": "eyJ...",
  "token_type": "bearer"
}
```

#### Login
```bash
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123"
}

Response: 200 OK
{
  "access_token": "eyJ...",
  "token_type": "bearer"
}
```

#### Get Current User
```bash
GET /auth/me
Authorization: Bearer eyJ...

Response: 200 OK
{
  "id": 1,
  "email": "user@example.com",
  "full_name": "John Doe",
  "is_verified": true,
  "is_active": true
}
```

#### Forgot Password
```bash
POST /auth/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}

Response: 200 OK
{
  "message": "If an account exists..."
}
```

#### Reset Password
```bash
POST /auth/reset-password
Content-Type: application/json

{
  "email": "user@example.com",
  "code": "123456",
  "new_password": "NewSecurePass123"
}

Response: 200 OK
{
  "message": "Password reset successfully"
}
```

#### Resend Verification Code
```bash
POST /auth/resend-verification-code
Content-Type: application/json

{
  "email": "user@example.com"
}

Response: 200 OK
{
  "message": "Verification code sent..."
}
```

## üîí Using Authentication in Code

### Python (FastAPI Dependencies)

```python
from fastapi import Depends
from app.auth_email import get_current_user, get_current_verified_user, EmailUser

# Require authenticated user (may not be verified)
@app.get("/protected")
def protected_route(user: EmailUser = Depends(get_current_user)):
    return {"user_id": user.id, "email": user.email}

# Require verified user
@app.get("/verified-only")
def verified_route(user: EmailUser = Depends(get_current_verified_user)):
    return {"message": f"Hello {user.email}"}
```

### JavaScript/TypeScript (Frontend)

```javascript
// Register
const registerUser = async (email, password, fullName) => {
  const response = await fetch('http://localhost:8000/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password, full_name: fullName })
  });
  return response.json();
};

// Verify email
const verifyEmail = async (email, code) => {
  const response = await fetch('http://localhost:8000/auth/verify-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, code })
  });
  const data = await response.json();
  // Store token
  localStorage.setItem('access_token', data.access_token);
  return data;
};

// Login
const login = async (email, password) => {
  const response = await fetch('http://localhost:8000/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  const data = await response.json();
  localStorage.setItem('access_token', data.access_token);
  return data;
};

// Authenticated request
const getProfile = async () => {
  const token = localStorage.getItem('access_token');
  const response = await fetch('http://localhost:8000/auth/me', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  return response.json();
};
```

## üìÅ File Uploads (Cloudinary)

The file upload system automatically uses Cloudinary:

```python
from app.utils.cloudinary_uploader import upload_audio

# Upload audio file
public_id, url = upload_audio(
    local_path="/path/to/audio.wav",
    user_id="123",
    job_id="456"
)

print(f"Uploaded to: {url}")
# Output: https://res.cloudinary.com/your-cloud/video/upload/...
```

## üìß Email Service (Resend)

Send custom emails:

```python
from app.utils.email_service import (
    send_verification_email,
    send_password_reset_email,
    send_welcome_email
)

# Send verification code
send_verification_email(
    to_email="user@example.com",
    verification_code="123456",
    user_name="John Doe"
)

# Send password reset
send_password_reset_email(
    to_email="user@example.com",
    reset_code="654321",
    user_name="John Doe"
)

# Send welcome email
send_welcome_email(
    to_email="user@example.com",
    user_name="John Doe"
)
```

## üóÑÔ∏è Database Schema

### Users Table
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    email VARCHAR UNIQUE NOT NULL,
    hashed_password VARCHAR NOT NULL,
    full_name VARCHAR,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Verification Codes Table
```sql
CREATE TABLE verification_codes (
    id INTEGER PRIMARY KEY,
    email VARCHAR NOT NULL,
    code VARCHAR NOT NULL,
    code_type VARCHAR NOT NULL,  -- 'email_verification' or 'password_reset'
    is_used BOOLEAN DEFAULT FALSE,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## üß™ Testing

### Manual Testing with cURL

```bash
# 1. Register
curl -X POST http://localhost:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!","full_name":"Test User"}'

# 2. Check email for code, then verify
curl -X POST http://localhost:8000/auth/verify-email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","code":"123456"}'

# 3. Login
curl -X POST http://localhost:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!"}'

# 4. Get profile (use token from login)
curl http://localhost:8000/auth/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### Testing with Python

```python
import requests

BASE_URL = "http://localhost:8000"

# Register
response = requests.post(f"{BASE_URL}/auth/register", json={
    "email": "test@example.com",
    "password": "Test123!",
    "full_name": "Test User"
})
print(response.json())

# Verify (get code from email)
response = requests.post(f"{BASE_URL}/auth/verify-email", json={
    "email": "test@example.com",
    "code": "123456"  # Replace with actual code
})
data = response.json()
token = data['access_token']

# Get profile
headers = {"Authorization": f"Bearer {token}"}
response = requests.get(f"{BASE_URL}/auth/me", headers=headers)
print(response.json())
```

## üîß Troubleshooting

### Emails not sending
- Check RESEND_API_KEY in .env
- Verify domain in Resend dashboard
- Check logs for error messages

### File upload fails
- Verify Cloudinary credentials in .env
- Check Cloudinary dashboard for quota
- Ensure file paths are correct

### Database errors
- Run: `python -c "from app.db import Base, engine; Base.metadata.create_all(bind=engine)"`
- Check DATABASE_URL in .env
- Delete dev.db and recreate if needed

### JWT token invalid
- Ensure JWT_SECRET_KEY is set and consistent
- Check token expiration (default 7 days)
- Verify Authorization header format: "Bearer {token}"

## üìñ See Also

- [MIGRATION_GUIDE.md](MIGRATION_GUIDE.md) - Full migration documentation
- [Resend Documentation](https://resend.com/docs)
- [Cloudinary Documentation](https://cloudinary.com/documentation)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
